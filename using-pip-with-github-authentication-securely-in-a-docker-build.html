<!DOCTYPE html><html lang=en class=has-navbar-fixed-top><head><title>Jeremy Fisher :: Using pip with github authentication securely in a docker build</title><meta charset=utf-8><meta name=generator content=Pelican><meta name=viewport content="width=device-width, initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=./theme/css/bulma.css><link rel=stylesheet href=./theme/css/style-1.0.css><script src=./theme/js/navbar.js></script><link rel=stylesheet href=./theme/highlight/monokai.css><script src=./theme/js/highlight.pack.js></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body id=index class=home><nav id=main-navbar class="navbar is-light is-fixed-top" role=navigation aria-label="main navigation"><div class=navbar-brand><a href=/ class=navbar-item><strong id=brand>Jeremy Fisher</strong></a><a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=navbarBasicExample><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div id=navbarBasicExample class=navbar-menu><div class=navbar-start></div><div class=navbar-end><a href=./ class=navbar-item>About</a><a class=navbar-item href=/blog>Blog</a></div></div></nav><div class=j-content-container><div class="j-content content"><section><header><h3><a class=article-title href=./using-pip-with-github-authentication-securely-in-a-docker-build.html rel=bookmark title="Permalink to Using pip with github authentication securely in a docker build">Using pip with github authentication securely in a docker build</a></h3></header><footer class=post-info><i class="fa fa-calendar"></i><time class=published datetime=2022-04-05T10:02:00+02:00> Tue 05 April 2022 </time></footer><hr><div class=entry-content><p>Here's an interesting trick. Say you need to build a docker container that installs a python package from a private github repository. How do you provide the credentials to <code>pip</code> without leaking those credentials? (<a href=https://pythonspeed.com/articles/docker-build-secrets/ >Here's an article</a> that does a good job explaining why this is an issue.)</p><p>The solution is <a href=https://docs.docker.com/develop/develop-images/build_enhancements/ >build kit</a>. This is a feature behind the <code>--secret</code> flag for Docker 18.09+. It allows mounting files and environment variables during a build step, such that those files are not acccessible afterwards in the intermediary layer artifacts.</p><p>This allows us to install dependencies by adding a personal access token to the github url, securely.</p><p>We can obtain a token as described <a href=https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token>here</a>.</p><p>For example, we would change the <code>docker build</code> command to the following to provide the secret token in the <code>$FOO_REPO_SECRET</code> environment variable. Note that build kit is disabled by default and must be enabled by setting the environment variable.</p><div class=highlight><pre><span></span><code><span class=nv>DOCKER_BUILDKIT</span><span class=o>=</span><span class=m>1</span> docker build --secret <span class=nv>id</span><span class=o>=</span>FOO_REPO_SECRET,env<span class=o>=</span>FOO_REPO_SECRET -t IMG_NAME .
</code></pre></div><p>This creates a file, <code>/run/secrets/FOO_REPO_SECRET</code>, with the contents of <code>$FOO_REPO_SECRET</code>. Then, accordingly, we would modify the Dockerfile: </p><div class=highlight><pre><span></span><code><span class=c># Dockerfile</span>
<span class=k>RUN</span><span class=w> </span>--mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>secret,id<span class=o>=</span>FOO_REPO_SECRET <span class=se>\</span>
    pip install git+https://<span class=k>$(</span>&lt;/run/secrets/FOO_REPO_SECRET<span class=k>)</span>@github.com/foo/bar
</code></pre></div><p>However, its not entirely robust. For example, this would fail if that repository had private dependencies itself. To deal with this, we would need to configure git.</p><p>Drawing from <a href=https://coolaj86.com/articles/vanilla-devops-git-credentials-cheatsheet/ >this article</a>, we can adapt the "Silver Bullet" to Docker. With the same build command, we would change the Dockerfile like so:</p><div class=highlight><pre><span></span><code><span class=k>RUN</span><span class=w> </span>git config --global url.<span class=s2>&quot;https://api@github.com/&quot;</span>.insteadOf <span class=s2>&quot;https://github.com/&quot;</span> <span class=se>\</span>
<span class=o>&amp;&amp;</span> git config --global url.<span class=s2>&quot;https://ssh@github.com/&quot;</span>.insteadOf <span class=s2>&quot;ssh://git@github.com/&quot;</span> <span class=se>\</span>
<span class=o>&amp;&amp;</span> git config --global url.<span class=s2>&quot;https://git@github.com/&quot;</span>.insteadOf <span class=s2>&quot;git@github.com:&quot;</span> <span class=se>\</span>
<span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&quot;cat /run/secrets/FOO_REPO_SECRET&quot;</span> &gt; /.git-askpass <span class=se>\</span>
<span class=o>&amp;&amp;</span> chmod +x /.git-askpass
<span class=k>ENV</span><span class=w> </span><span class=nv>GIT_ASKPASS</span><span class=o>=</span>/.git-askpass
<span class=k>RUN</span><span class=w> </span>--mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>secret,id<span class=o>=</span>FOO_REPO_SECRET <span class=se>\</span>
pip install -r requirements.txt
</code></pre></div></div></section><script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  }
};
document.addEventListener('DOMContentLoaded', (event) => {
  document.querySelectorAll('pre').forEach((block) => {
    hljs.highlightBlock(block);
  });
});
</script></div></div></body></html>